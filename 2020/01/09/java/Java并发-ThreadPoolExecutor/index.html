<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 3.8.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>Java并发-ThreadPoolExecutor深度解析 - Crowley技术博客</title>









<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">



<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="Java并发-ThreadPoolExecutor深度解析" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main">
<div class="card">
    
    <div class="card-image">
        <span  class="image is-7by1">
            <img class="thumbnail" src="http://syxtt.xin/线程池图片.jpg" alt="Java并发-ThreadPoolExecutor深度解析">
        </span>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-01-09T11:33:16.000Z">2020-01-09</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 10758 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Java并发-ThreadPoolExecutor深度解析
            
        </h1>
        <div class="content">
            <p>ThreadPoolExecutor搞不懂？看这篇就够了<br><a id="more"></a></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文部分内容摘抄自<a href="http://www.throwable.club/2019/07/15/java-concurrency-thread-pool-executor/" target="_blank" rel="noopener">throwable作者的博文</a>，有些部分作者已经总结的很好，没必要再重复发明轮子，在这里感谢作者。本文的亮点在于:</p>
<ul>
<li>对<code>ThreadPoolExecutor</code>的依赖关系，作了细致的分解以宏观层面了解<code>Doug Lea</code>的设计理念。</li>
<li>总结了<code>ThreadPoolExecutor</code>的核心流程，归纳了重要的结论。</li>
<li><code>ThreadPoolExecutor</code>源码逐行解析。</li>
<li>例举了场景，加深理解线程池工作原理。</li>
</ul>
<p>由于<code>ThreadPoolExecutor</code>的代码逻辑和设计理念比较复杂，建议大家学习的时候，多思考，顺着代码的思路，多动动笔画一画才能加深理解。</p>
<h1 id="提出问题"><a href="#提出问题" class="headerlink" title="提出问题"></a>提出问题</h1><p>这些问题也是我当时的疑惑点，按本文的思路学习<code>ThreadPoolExecutor</code>，这些问题迎刃而解。</p>
<p>1、创建一个线程池需要哪些参数？</p>
<p>2、线程池中的状态都有哪些？是如何实现的？</p>
<p>3、线程池为什么需要工作队列？有哪几种工作队列？</p>
<p>4、AQS在线程池中扮演什么角色？它的作用是什么？</p>
<p>5、线程池在<code>shutdown</code>的时候，如何保证任务不丢失？如何保证任务正常执行完毕？</p>
<p>、线程池在<code>shutdown</code>之后还能提交任务进来嘛？线程池在<code>shutdownNow</code>之后还能提交任务进来吗？</p>
<p>9、<code>ThreadPoolExecutor</code>是如何控制工作线程能够重复利用的。</p>
<p>10、<code>ThreadPoolExecutor</code>的执行结果是如何到<code>Futrue</code>中的？</p>
<h1 id="前置知识复习"><a href="#前置知识复习" class="headerlink" title="前置知识复习"></a>前置知识复习</h1><h2 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h2><p>如下图所示，Java中线程可分为NEW，RUNABLE，RUNING，BLOCKED，WAITING，TIMED_WAITING，TERMINATED 共七个状态，一个状态是如何过渡到另一个状态图中标识的很清楚。</p>
<p><img src="http://syxtt.xin/线程状态.png" alt="线程状态示意图"></p>
<ul>
<li><strong>初始状态（NEW）</strong><br>实现Runnable接口和继承Thread可以得到一个线程类，new一个实例出来，线程就进入了初始状态。</li>
<li><strong>就绪状态（RUNNABLE）</strong><br>就绪状态只是说你资格运行，调度程序没有挑选到你，你就永远是就绪状态。<ul>
<li>调用线程的<strong>start()</strong>方法，此线程进入就绪状态。</li>
<li>当前线程sleep()方法结束，其他线程join()结束，等待用户输入完毕，某个线程拿到对象锁，这些线程也将进入就绪状态。</li>
<li>当前线程时间片用完了，调用当前线程的yield()方法，当前线程进入就绪状态。</li>
<li>锁池里的线程拿到对象锁后，进入就绪状态。</li>
</ul>
</li>
<li><strong>运行中状态（RUNNING）</strong><br>线程调度程序从可运行池中选择一个线程作为当前线程时线程所处的状态。这也是线程进入运行状态的唯一一种方式。</li>
<li><strong>阻塞状态（BLOCKED）</strong><br>阻塞状态是线程阻塞在进入synchronized关键字（当然也包括ReentrantLock）修饰的方法或代码块(获取锁)时的状态。</li>
<li><strong>等待（WAITING）</strong><br>处于这种状态的线程不会被分配CPU执行时间，它们要等待被显式地唤醒，否则会处于无限期等待的状态。</li>
<li><strong>超时等待（TIMED_WAITING）</strong><br>处于这种状态的线程不会被分配CPU执行时间，不过无须无限期等待被其他线程显示地唤醒，在达到一定时间后它们会自动唤醒。</li>
<li><strong>终止状态（TERMINATED）</strong><br>当线程的run()方法完成时，或者主线程的main()方法完成时，我们就认为它终止了。这个线程对象也许是活的，但是，它已经不是一个单独执行的线程。线程一旦终止了，就不能复生。在一个终止的线程上调用start()方法，会抛出java.lang.IllegalThreadStateException异常。</li>
</ul>
<h2 id="线程池的作用"><a href="#线程池的作用" class="headerlink" title="线程池的作用"></a>线程池的作用</h2><p>1、减少了创建和销毁线程的次数，可以重复利用工作线程</p>
<p>2、规范化线程的使用，避免创建过多的线程导致耗尽系统资源</p>
<p>3、丰富的线程管理手段和结果控制</p>
<h1 id="ThreadPoolExecutor的原理"><a href="#ThreadPoolExecutor的原理" class="headerlink" title="ThreadPoolExecutor的原理"></a>ThreadPoolExecutor的原理</h1><p>由ThreadPool原理图所示，<code>ThreadPoolExecutor</code>的核心组件包括：</p>
<ul>
<li>ThreadFactory：线程工厂，用于创建工作线程，默认的线程工厂是<code>Executors.defaultThreadFactory()</code></li>
<li>workQueue：阻塞工作队列，常用的有<code>ArrayBlockingQueue</code>，<code>LinkedBlockingQueue</code></li>
<li>工作线程池：内部包含了<code>cw(core worker)</code>和<code>aw(additional worker)</code></li>
<li>RejectedExecutionHandler：拒绝执行处理器</li>
</ul>
<p><img src="http://syxtt.xin/image/blog/ThreadPool%E5%8E%9F%E7%90%86%E5%9B%BE.jpg" alt="ThreadPool原理图"></p>
<h2 id="类的设计"><a href="#类的设计" class="headerlink" title="类的设计"></a>类的设计</h2><p> <code>ThreadPoolExecutor</code>的类图。<img src="http://syxtt.xin/image/blog/ThreadPoolExecutor%E7%B1%BB%E5%9B%BE.jpg" alt="ThreadPoolExecutor类图"></p>
<h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><p><code>Executor</code>该接口提供了一种将任务提交与每个任务将如何运行的机制，包括线程执行，调度等。<code>Doug Lea</code>将线程的执行抽象为<code>任务(task)</code>，<code>任务</code>由各种实现<code>Executor</code>的执行器执行，具体执行的内容在执行器中回调。</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Executor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 在不远的将来执行用户提供的command。</span></span><br><span class="line"><span class="hljs-comment">     * command或许在一个新的线程中执行，或者在线程池中执行，或许在调用的线程中。</span></span><br><span class="line"><span class="hljs-comment">     * 具体的执行方式在Executor的实现类实现</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> command runnable任务</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException 如果command不能被Execute接受</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException comman是null</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(Runnable command)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ExecutorService"><a href="#ExecutorService" class="headerlink" title="ExecutorService"></a>ExecutorService</h3><p><code>ExecutorService</code>实现了<code>Executor</code>接口，它提供了一系列方法<code>管理终止(manage termination)</code>和用于追踪一个或多个异步任务最终返回<code>Future</code>的方法。<code>ExecutorService</code>可以<code>关闭（shutdown）</code>，关闭之后会拒绝新的任务。定义了两种关闭<code>ExecutorService</code>的方法。</p>
<ul>
<li><code>shutdown()</code>启动一个有序关闭，在该关闭中先执行已提交的任务，单不接受任何新的任务。如果执行器已经关闭，再次调用该方法也不会产生影响。该方法不负责等待已提交任务完成执行，<code>awaitTermination</code>来完成此项职责，在执行器发起<code>shutdown request</code>之后，它将阻塞直到所有任务已完成，或者触发了<code>timeout</code>，或者线程被<code>中断(interrupted)</code>，无论这三种情况中的哪一种先触发，都会解除阻塞。</li>
<li><code>shutdownNow()</code>尝试停止所有正在执行的任务，忽略正在等待的任务，并返回正在等待执行的任务的列表。该方法不负责等待已提交任务完成执行，<code>awaitTermination</code>来完成此项职责。除了尽最大努力尝试停止处理正在执行的任务之外，没有任何保证。比如，终止线程的方法是通过<code>Thread.interupt()</code>方法实现，但是如果任务中没有处理过中断，则<code>shutdownNow()</code>也无计可施，只能等待任务自然执行完毕。</li>
</ul>
<p><code>终止(termination)</code>时，执行器中没有任务在执行，没有任务在等待执行，更没有任务可以提交进执行器。终止后应关闭执行器，释放资源。</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ExecutorService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Executor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shutdown</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function">List&lt;Runnable&gt; <span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span></span>;</span><br><span class="line">    <span class="hljs-comment">//执行器是否关闭</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isShutdown</span><span class="hljs-params">()</span></span>;</span><br><span class="line">		<span class="hljs-comment">//在调用shutdown之后，所有任务都已经完成，则返回true.</span></span><br><span class="line">    <span class="hljs-comment">//如果不提前调用shutdown或者shutdownNow，该方法不可能返回true</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isTerminated</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">awaitTermination</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="hljs-function">        <span class="hljs-keyword">throws</span> InterruptedException</span>;</span><br><span class="line">    <span class="hljs-comment">//提交一个Callable任务，有返回值并返回一个Future对象代表任务执行的结果。Future的get方法将等待任务执行完毕。</span></span><br><span class="line">    &lt;T&gt; <span class="hljs-function">Future&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span></span>;</span><br><span class="line">    <span class="hljs-comment">//提交一个Runnable任务，并返回Futrue对象</span></span><br><span class="line">    &lt;T&gt; <span class="hljs-function">Future&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(Runnable task, T result)</span></span>;</span><br><span class="line"></span><br><span class="line">    Future&lt;?&gt; submit(Runnable task);</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span><br><span class="line">        <span class="hljs-keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span><br><span class="line">                                  <span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span><br><span class="line">        <span class="hljs-keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">invokeAny</span><span class="hljs-params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span></span><br><span class="line"><span class="hljs-function">        <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">invokeAny</span><span class="hljs-params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                    <span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="hljs-function">        <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException, TimeoutException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Futrue"><a href="#Futrue" class="headerlink" title="Futrue"></a>Futrue</h3><p><strong>Futrue</strong>代表了异步执行的结果。提供了检测执行完成的方法，等待完成的方法，重试完成方法等控制结果的方法。</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Future</span>&lt;<span class="hljs-title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 尝试取消执行这个任务.任务完成或者任务取消或者一些其他的原因会导致尝试失败。</span></span><br><span class="line"><span class="hljs-comment">     * 如果任务还未开始执行，取消成功，那么这个任务将永远不会执行。</span></span><br><span class="line"><span class="hljs-comment">     * 如果任务已经开始执行，取消成功，则mayInterruptIfRunning参数来决定是不是中断线程</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">cancel</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> mayInterruptIfRunning)</span></span>;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    *  如果任务在执行完成前被取消，则返回true</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isCancelled</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 如果任务正常执行完毕则返回true</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isDone</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 等待执行结果</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the computed result</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> CancellationException 如果任务被取消</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ExecutionException 执行过程中出现异常</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 如果任务被中断</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function">V <span class="hljs-title">get</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 在有限时间内等待执行结果</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> CancellationException 如果任务被取消</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ExecutionException 执行过程中出现异常</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 如果任务被中断</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> TimeoutException 如果任务超时</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function">V <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="hljs-function">        <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException, TimeoutException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般情况下常用的实现是<code>FutureTask</code>,它是一个可取消的异步执行结果集，它实现了Futrue接口中定义的功能。</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FutureTask</span>&lt;<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">RunnableFuture</span>&lt;<span class="hljs-title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 任务的运行状态,初始状态为NEW.  </span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * 可能的状态变换为:</span></span><br><span class="line"><span class="hljs-comment">     * NEW -&gt; COMPLETING -&gt; NORMAL</span></span><br><span class="line"><span class="hljs-comment">     * NEW -&gt; COMPLETING -&gt; EXCEPTIONAL</span></span><br><span class="line"><span class="hljs-comment">     * NEW -&gt; CANCELLED</span></span><br><span class="line"><span class="hljs-comment">     * NEW -&gt; INTERRUPTING -&gt; INTERRUPTED</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> state;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> NEW          = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> COMPLETING   = <span class="hljs-number">1</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> NORMAL       = <span class="hljs-number">2</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> EXCEPTIONAL  = <span class="hljs-number">3</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> CANCELLED    = <span class="hljs-number">4</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> INTERRUPTING = <span class="hljs-number">5</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> INTERRUPTED  = <span class="hljs-number">6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/** The underlying callable; nulled out after running */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> Callable&lt;V&gt; callable;</span><br><span class="line">    <span class="hljs-comment">/** 任务执行结果，get()方法获取的就是这个对象 */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> Object outcome; <span class="hljs-comment">// non-volatile, protected by state reads/writes</span></span><br><span class="line">    <span class="hljs-comment">/** The thread running the callable; CASed during run() */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Thread runner;</span><br><span class="line">    <span class="hljs-comment">/** Treiber stack of waiting threads */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> WaitNode waiters; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://syxtt.xin/image/blog/FutureTask%E7%B1%BB%E5%9B%BE.png" alt="FutureTask类图"></p>
<h3 id="AbstractExecutorService"><a href="#AbstractExecutorService" class="headerlink" title="AbstractExecutorService"></a>AbstractExecutorService</h3><p><code>AbstractExecutorService</code>提供了<code>ExecutorService</code>的默认实现，实现了<code>submit</code>，<code>invokeAny</code>，<code>invokeAll</code>，通过<code>FutureTask</code>类对Runnable执行过程进行包装。</p>
<h3 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h3><p><code>ThreadPoolExecutor</code>是线程池实现类，它依赖了上面提到的所有类，也是本篇博文重点讲述的类。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过对<code>ThreadPoolExecutor</code>依赖的类的了解，更能从宏观上理解作者的设计思想。<code>Executor</code>将<strong>并发执行的线程抽象成任务，交给任务执行器来执行</strong>，<code>ExecutorService</code>定义了任务执行器的关闭和提交任务。</p>
<h2 id="线程池状态"><a href="#线程池状态" class="headerlink" title="线程池状态"></a>线程池状态</h2><p>如下代码所示，线程池的状态分为了</p>
<ul>
<li>RUNNING：接受新的任务和处理队列中的任务</li>
<li>SHUTDOWN：拒绝新的任务，但是处理队列中的任务</li>
<li>STOP：拒绝新的任务，不处理队列中的任务，并且中断在执行的任务</li>
<li>TIDYING：所有任务已经终止（terminated），workerCount=0，线程</li>
<li>TERMINATED：terminated已完成</li>
</ul>
<p>线程池的状态按如下方式进行转换</p>
<ul>
<li>RUNNING-&gt;SHUTDOWN 调用<code>shutdown()</code>方法</li>
<li>(RUNNING or SHUTDOWN) -&gt; STOP，调用<code>shutdownNow()</code></li>
<li>SHUTDOWN -&gt; TIDYING，当队列和线程池都为空</li>
<li>STOP-&gt;TIDYING,线程池为空</li>
<li>TIDYING -&gt; TERMINATED，当<code>terminated()</code> hook method 执行完毕，所有线程都在<code>awaitTermination()</code>中等待线程池状态到达TERMINATED。</li>
</ul>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//接受新的任务和处理队列中的任务</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> RUNNING    = -<span class="hljs-number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="hljs-comment">//拒绝新的任务，但是处理队列中的任务</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SHUTDOWN   =  <span class="hljs-number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="hljs-comment">//拒绝新的任务，不处理队列中的任务，并且中断在执行的任务</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> STOP       =  <span class="hljs-number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="hljs-comment">//所有任务已经终止（terminated），workerCount=0，线程</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> TIDYING    =  <span class="hljs-number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="hljs-comment">//terminated已完成</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> TERMINATED =  <span class="hljs-number">3</span> &lt;&lt; COUNT_BITS;</span><br></pre></td></tr></table></figure>
<h2 id="核心流程"><a href="#核心流程" class="headerlink" title="核心流程"></a>核心流程</h2><h3 id="任务提交核心流程"><a href="#任务提交核心流程" class="headerlink" title="任务提交核心流程"></a>任务提交核心流程</h3><p>根据下图所示的任务提交核心流程，主要是<code>ThreadPoolExecutor#execute()</code>方法，核心流程总结为以下结论：</p>
<ul>
<li>核心线程数小于<code>corePoolSize</code>，则需要创建新的工作线程来执行任务</li>
<li>核心线程数大于等于<code>corePoolSize</code>，需要将线程放入到阻塞任务队列中等待执行</li>
<li>队列满时需要创建非核心线程来执行任务，所有工作线程（核心线程+非核心线程）数量要小于等于<code>maximumPoolSize</code></li>
<li>如果工作线程数量已经达到<code>maximumPoolSize</code>，则拒绝任务，执行拒绝策略</li>
</ul>
<blockquote>
<p>TIP：这里需要注意对<strong>核心线程</strong>和<strong>非核心线程</strong>的理解，它们不是工作线程的状态，核心线程提出的目的，是为了尽量维持工作线程的数量在<code>corePoolSize</code>。</p>
</blockquote>
<p><img src="http://syxtt.xin/image/blog/ThreadPoolExecutor%23execute%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="ThreadPoolExecutor#execute方法核心逻辑"></p>
<h3 id="创建工作线程核心流程"><a href="#创建工作线程核心流程" class="headerlink" title="创建工作线程核心流程"></a>创建工作线程核心流程</h3><p>根据下图对<code>java.util.concurrent.ThreadPoolExecutor#addWorker</code>的分析，可以得出如下结论：</p>
<ul>
<li>只有工作线程被添加到线程池中并且工作线程start，才算添加成功，否则<code>Worker</code>对象只是一个临时对象（被GC掉）</li>
<li>状态为<code>STOP</code>，<code>TIDYING</code>，<code>TERMINATED</code>这三种时，是不会增加工作线程的</li>
<li>状态为<code>SHUTDOWN</code>时是一个重要的边界条件</li>
</ul>
<p><img src="http://syxtt.xin/image/blog/ThreadPoolExecutor%23addWorker%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="ThreadPoolExecutor#addWorker(Runnable firstTask, boolean core)"></p>
<h3 id="任务执行核心流程"><a href="#任务执行核心流程" class="headerlink" title="任务执行核心流程"></a>任务执行核心流程</h3><p>如下图是任务执行的流程，可以总结如下：</p>
<ul>
<li>提交任务时如果<strong>工作线程</strong>数量小于核心线程数量，则<code>firstTask != null</code>，一路顺利执行然后阻塞在队列的poll上。</li>
<li>提交任务时如果<strong>工作线程</strong>数量大于等于核心线程数量，则<code>firstTask == null</code>，需要从任务队列中poll一个任务执行，执行完毕之后继续阻塞在队列的poll上。</li>
<li>提交任务时如果<strong>工作线程</strong>数量大于等于核心线程数量并且任务队列已满，需要创建一个<strong>非核心线程</strong>来执行任务，则<code>firstTask != null</code>，执行完毕之后继续阻塞在队列的poll上，不过注意这个poll是允许超时的，最多等待时间为<code>keepAliveTime</code>。</li>
<li>工作线程在跳出循环之后，线程池会移除该线程对象，并且试图终止线程池（因为需要考量shutdown的情况）</li>
<li><code>ThreadPoolExecutor</code>提供了任务执行前和执行后的钩子方法，分别为<code>beforeExecute</code>和<code>afterExecute</code>。</li>
<li>工作线程通过实现<code>AQS</code>来保证线程安全（每次执行任务的时候都会<code>lock</code>和<code>unlock</code>）</li>
</ul>
<p><img src="http://syxtt.xin/java.util.concurrent.ThreadPoolExecutor#runWorker流程图.jpg" alt="任务执行核心流程"></p>
<h3 id="线程池关闭核心流程"><a href="#线程池关闭核心流程" class="headerlink" title="线程池关闭核心流程"></a>线程池关闭核心流程</h3><p>如下图是<code>shutdown</code>方法的流程图，它是一种“温和“的关闭方式，执行完<code>shutdown</code>之后，会把线程状态置为<code>SHUTDOWN</code>，线程池并不会立即关闭，而是先中断能中断的工作线程，有些工作线程正在执行任务中，那么就先不中断，等待它们执行完毕之后中断工作线程。</p>
<p><img src="http://syxtt.xin/java.util.concurrent.ThreadPoolExecutor#shutdown流程图新.jpg" alt="java.util.concurrent.ThreadPoolExecutor#shutdown流程图"></p>
<p>如下图是<code>shutdownNow</code>的流程图，与<code>shutdown</code>不同的地方在于，它关闭线程池的方式比较“粗暴”，直接把线程池状态置为<code>STOP</code>。不管工作线程是否在执行，全部一一中断，也不等待队列中未执行的任务，把它们返回给客户线程由客户线程自行处置。</p>
<p><img src="http://syxtt.xin/java.util.concurrent.ThreadPoolExecutor#shutdownNow流程图.jpg" alt="java.util.concurrent.ThreadPoolExecutor#shutdownNow流程图"></p>
<h1 id="ThreadPoolExecutor源码分析"><a href="#ThreadPoolExecutor源码分析" class="headerlink" title="ThreadPoolExecutor源码分析"></a>ThreadPoolExecutor源码分析</h1><p>源码分析主要从重要成员变量和核心方法两个层面来讲解。</p>
<h2 id="关键属性"><a href="#关键属性" class="headerlink" title="关键属性"></a>关键属性</h2><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadPoolExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractExecutorService</span> </span>&#123;</span><br><span class="line">  <span class="hljs-comment">//控制变量-存放状态和线程数</span></span><br><span class="line">	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicInteger ctl = <span class="hljs-keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="hljs-number">0</span>));</span><br><span class="line">  <span class="hljs-comment">//线程池阻塞队列</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line">  <span class="hljs-comment">//工作线程集合，存放（活跃的）工作线程，只有持有mainLock才能访问这个集合。</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">  <span class="hljs-comment">//全局锁</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="hljs-comment">//awaitTermination方法使用的等待条件变量</span></span><br><span class="line">	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Condition termination = mainLock.newCondition();</span><br><span class="line">  <span class="hljs-comment">//记录峰值线程数，只有持有全局锁才能访问</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> largestPoolSize;</span><br><span class="line">  <span class="hljs-comment">//记录完成任务数，只有持有全局锁才能访问</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> completedTaskCount;</span><br><span class="line">  <span class="hljs-comment">//线程工厂</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> ThreadFactory threadFactory;</span><br><span class="line">  <span class="hljs-comment">//拒绝执行处理器</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> RejectedExecutionHandler handler;</span><br><span class="line">  <span class="hljs-comment">//任务超时时间</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">long</span> keepAliveTime;</span><br><span class="line">  <span class="hljs-comment">//是否允许coreSize超时，默认不允许</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">boolean</span> allowCoreThreadTimeOut;</span><br><span class="line">  <span class="hljs-comment">//线程池容量</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> maximumPoolSize;</span><br><span class="line">  </span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Worker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueuedSynchronizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;</span><br><span class="line">			<span class="hljs-comment">//工作线程</span></span><br><span class="line">      <span class="hljs-keyword">final</span> Thread thread;</span><br><span class="line">      <span class="hljs-comment">//初始要执行的任务，有可能是null</span></span><br><span class="line">    	Runnable firstTask;</span><br><span class="line">      <span class="hljs-comment">//每一个线程完成的任务数量</span></span><br><span class="line">    	<span class="hljs-keyword">volatile</span> <span class="hljs-keyword">long</span> completedTasks;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 创建线程池</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> corePoolSize 核心线程数量</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> maximumPoolSize 最大线程容量</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> keepAliveTime 超过CoreSize的工作线程保持的时间，超时即终止</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> unit keepAliveTime的单位</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> workQueue 阻塞工作队列</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory 线程工厂，默认Executors.defaultThreadFactory()</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler 拒绝执行处理回调</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</span></span><br><span class="line"><span class="hljs-comment">     *         &#123;<span class="hljs-doctag">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="hljs-comment">     *         &#123;<span class="hljs-doctag">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="hljs-comment">     *         &#123;<span class="hljs-doctag">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="hljs-comment">     *         &#123;<span class="hljs-doctag">@code</span> maximumPoolSize &lt; corePoolSize&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if &#123;<span class="hljs-doctag">@code</span> workQueue&#125;</span></span><br><span class="line"><span class="hljs-comment">     *         or &#123;<span class="hljs-doctag">@code</span> threadFactory&#125; or &#123;<span class="hljs-doctag">@code</span> handler&#125; is null</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                              <span class="hljs-keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                              <span class="hljs-keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                              ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                              RejectedExecutionHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (corePoolSize &lt; <span class="hljs-number">0</span> ||</span><br><span class="line">            maximumPoolSize &lt;= <span class="hljs-number">0</span> ||</span><br><span class="line">            maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">            keepAliveTime &lt; <span class="hljs-number">0</span>)</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="hljs-keyword">if</span> (workQueue == <span class="hljs-keyword">null</span> || threadFactory == <span class="hljs-keyword">null</span> || handler == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="hljs-keyword">this</span>.acc = System.getSecurityManager() == <span class="hljs-keyword">null</span> ?</span><br><span class="line">                <span class="hljs-keyword">null</span> :</span><br><span class="line">                AccessController.getContext();</span><br><span class="line">        <span class="hljs-keyword">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">        <span class="hljs-keyword">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">        <span class="hljs-keyword">this</span>.workQueue = workQueue;</span><br><span class="line">        <span class="hljs-keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">        <span class="hljs-keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">        <span class="hljs-keyword">this</span>.handler = handler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="状态控制"><a href="#状态控制" class="headerlink" title="状态控制"></a>状态控制</h2><p><strong>在ThreadPoolExecutor中是通过位运算来处理状态的</strong>。位运算的基础是理解<strong>原码</strong>，<strong>反码</strong>，<strong>补码</strong>，用<code>int ctl = 1来举例</code></p>
<ul>
<li>原码: <code>0000 0000 0000 0000 0000 0000 0000 0001</code>，十进制是<code>1</code></li>
<li>反码:<code>1111 1111 1111 1111 1111 1111 1111 1110</code>,十进制是<code>-2</code></li>
<li>补码:<code>1111 1111 1111 1111 1111 1111 1111 1111</code>, 十进制是<code>-1</code></li>
</ul>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//ctl的初始值是1110 0000 0000 0000 0000 0000 0000 0000，即状态为RUNNING，worker数量为0</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicInteger ctl = <span class="hljs-keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="hljs-number">0</span>));  	</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//Java中Integer是32位，所以COUNT_BITS等于29</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="hljs-number">3</span>;</span><br><span class="line">  <span class="hljs-comment">//0001 1111 1111 1111 1111 1111 1111 1111</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> CAPACITY   = (<span class="hljs-number">1</span> &lt;&lt; COUNT_BITS) - <span class="hljs-number">1</span>;    </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//-1左移29位 1110 0000 0000 0000 0000 0000 0000 0000 高3位 111代表运行中</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> RUNNING    = -<span class="hljs-number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">  <span class="hljs-comment">//0 左移 29位  高三位000代表SHUTDOWN</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SHUTDOWN   =  <span class="hljs-number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">  <span class="hljs-comment">//1 左移 29位  高三位001代表STOP</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> STOP       =  <span class="hljs-number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">  <span class="hljs-comment">//2 左移 29位  高三位010代表TIDYING</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> TIDYING    =  <span class="hljs-number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">  <span class="hljs-comment">//3 左移 29位  高三位011代表TERMINATED</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> TERMINATED =  <span class="hljs-number">3</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">//获取线程池状态，CAPACITY取反是 1110 0000 0000 0000 0000 0000 0000 0000</span></span><br><span class="line">  <span class="hljs-comment">//c &amp; ~CAPACITY ,c代表ctl值，因为低29位都是0，所以与操作得出的值只与高三位相关</span></span><br><span class="line">  <span class="hljs-comment">//这个算法证明：ctl高三位决定了线程池的状态</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">runStateOf</span><span class="hljs-params">(<span class="hljs-keyword">int</span> c)</span>     </span>&#123; <span class="hljs-keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line">  <span class="hljs-comment">//获取worder数量，低29位于ctl与操作</span></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">workerCountOf</span><span class="hljs-params">(<span class="hljs-keyword">int</span> c)</span>  </span>&#123; <span class="hljs-keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ctlOf</span><span class="hljs-params">(<span class="hljs-keyword">int</span> rs, <span class="hljs-keyword">int</span> wc)</span> </span>&#123; <span class="hljs-keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure>
<p>工作线程为0的前提下，小结下线程池的运行状态：</p>
<table>
<thead>
<tr>
<th style="text-align:center">状态名称</th>
<th style="text-align:center">位图</th>
<th style="text-align:center">十进制值</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>RUNNING</code></td>
<td style="text-align:center"><code>111-00000000000000000000000000000</code></td>
<td style="text-align:center">-536870912</td>
<td style="text-align:center">运行中状态，可以接收新的任务和执行任务队列中的任务</td>
</tr>
<tr>
<td style="text-align:center"><code>SHUTDOWN</code></td>
<td style="text-align:center"><code>000-00000000000000000000000000000</code></td>
<td style="text-align:center">0</td>
<td style="text-align:center">shutdown状态，不再接收新的任务，但是会执行任务队列中的任务</td>
</tr>
<tr>
<td style="text-align:center"><code>STOP</code></td>
<td style="text-align:center"><code>001-00000000000000000000000000000</code></td>
<td style="text-align:center">536870912</td>
<td style="text-align:center">停止状态，不再接收新的任务，也不会执行任务队列中的任务，中断所有执行中的任务</td>
</tr>
<tr>
<td style="text-align:center"><code>TIDYING</code></td>
<td style="text-align:center"><code>010-00000000000000000000000000000</code></td>
<td style="text-align:center">1073741824</td>
<td style="text-align:center">整理中状态，所有任务已经终结，工作线程数为0，过渡到此状态的工作线程会调用钩子方法<code>terminated()</code></td>
</tr>
<tr>
<td style="text-align:center"><code>TERMINATED</code></td>
<td style="text-align:center"><code>011-00000000000000000000000000000</code></td>
<td style="text-align:center">1610612736</td>
<td style="text-align:center">终结状态，钩子方法<code>terminated()</code>执行完毕</td>
</tr>
</tbody>
</table>
<p>这里有一个比较特殊的技巧，由于运行状态值存放在高3位，所以可以直接通过十进制值（<strong>甚至可以忽略低29位，直接用<code>ctl</code>进行比较，或者使用<code>ctl</code>和线程池状态常量进行比较</strong>）来比较和判断线程池的状态：</p>
<blockquote>
<p>工作线程数为0的前提下：RUNNING(-536870912) &lt; SHUTDOWN(0) &lt; STOP(536870912) &lt; TIDYING(1073741824) &lt; TERMINATED(1610612736)</p>
</blockquote>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// ctl和状态常量比较，判断是否小于</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">runStateLessThan</span><span class="hljs-params">(<span class="hljs-keyword">int</span> c, <span class="hljs-keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> c &lt; s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// ctl和状态常量比较，判断是否小于或等于</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">runStateAtLeast</span><span class="hljs-params">(<span class="hljs-keyword">int</span> c, <span class="hljs-keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> c &gt;= s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// ctl和状态常量SHUTDOWN比较，判断是否处于RUNNING状态</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isRunning</span><span class="hljs-params">(<span class="hljs-keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> c &lt; SHUTDOWN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后是线程池状态的跃迁图：</p>
<p><img src="http://syxtt.xin/image/blog/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%8A%B6%E6%80%81%E8%B7%83%E8%BF%81%E5%9B%BE.jpg" alt="线程池状态跃迁图"></p>
<h2 id="核心方法总体概括"><a href="#核心方法总体概括" class="headerlink" title="核心方法总体概括"></a>核心方法总体概括</h2><h2 id="execute方法源码分析"><a href="#execute方法源码分析" class="headerlink" title="execute方法源码分析"></a>execute方法源码分析</h2><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * 异步执行给定的task，即可能用新的线程执行任务，也可以用线程池中已存在的线程执行任务</span></span><br><span class="line"><span class="hljs-comment">  * 如果线程池已经shutdown，那么会拒绝执行任务并抛出异常，由RejectedExecutionHandler处理</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> command 要执行的任务</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@throws</span> RejectedExecutionException at discretion of</span></span><br><span class="line"><span class="hljs-comment">  *         &#123;<span class="hljs-doctag">@code</span> RejectedExecutionHandler&#125;, if the task</span></span><br><span class="line"><span class="hljs-comment">  *         cannot be accepted for execution</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@throws</span> NullPointerException if &#123;<span class="hljs-doctag">@code</span> command&#125; is null</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(Runnable command)</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">if</span> (command == <span class="hljs-keyword">null</span>)</span><br><span class="line">         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();</span><br><span class="line">     <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">      * Proceed in 3 steps:</span></span><br><span class="line"><span class="hljs-comment">      *</span></span><br><span class="line"><span class="hljs-comment">      * 1. 如果工作线程小于corePoolSize，ThreadPoolExecutor会把command当成firstTask，</span></span><br><span class="line"><span class="hljs-comment">      * 交给新创建的线程。addWorker函数会校验线程池状态和线程池数量.</span></span><br><span class="line"><span class="hljs-comment">      *</span></span><br><span class="line"><span class="hljs-comment">      * 2. 如果任务能够入队, 我们还是要进行double-check是否新加线程还是用线程池中的工作线程,因为线程可能在最后一次check的时候死掉. </span></span><br><span class="line"><span class="hljs-comment">      *</span></span><br><span class="line"><span class="hljs-comment">      * 3. 如果任务没有进入队列，就尝试创建一个新的线程。如果创建失败了，则线程池shutdown或者饱和，拒绝了这次请求</span></span><br><span class="line"><span class="hljs-comment">      */</span></span><br><span class="line">     <span class="hljs-keyword">int</span> c = ctl.get();</span><br><span class="line">     <span class="hljs-comment">//如果工作线程数量小于corePoolSize则创建一个core worker</span></span><br><span class="line">     <span class="hljs-keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">         <span class="hljs-comment">//默认把command当做firstTask</span></span><br><span class="line">         <span class="hljs-keyword">if</span> (addWorker(command, <span class="hljs-keyword">true</span>))</span><br><span class="line">             <span class="hljs-keyword">return</span>;</span><br><span class="line">         c = ctl.get();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-comment">//说明创建新的核心线程失败，也就是当前工作线程数大于等于corePoolSize</span></span><br><span class="line">     <span class="hljs-comment">//判定线程池是否是RUNNING,工作队列添加command</span></span><br><span class="line">     <span class="hljs-keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">         <span class="hljs-comment">//再次确认状态，如果线程池状态不是RUNNING并且移除成功则拒绝掉command</span></span><br><span class="line">         <span class="hljs-keyword">int</span> recheck = ctl.get();</span><br><span class="line">         <span class="hljs-keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">             reject(command);</span><br><span class="line">         <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (workerCountOf(recheck) == <span class="hljs-number">0</span>)</span><br><span class="line">             addWorker(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!addWorker(command, <span class="hljs-keyword">false</span>))</span><br><span class="line">         reject(command);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里简单的分析下流程：</p>
<ul>
<li>如果工作线程数量小于核心线程数量<code>workerCountOf(c) &lt; corePoolSize</code>，则直接创建核心线程执行任务</li>
<li>如果工作线程数量大于等于核心线程数量，判断线程池状态，并把任务放入到阻塞队列中等待调度。这里会进行二次检查线程池的状态，如果当前工作线程数量为0，则创建一个非核心线程并传入的任务对象为null。</li>
<li>如果添加任务队列失败，则说明阻塞队列已满，尝试创建非核心线程</li>
<li>如果创建非核心线程失败，则证明线程池已经饱和，调用拒绝策略执行任务</li>
</ul>
<p><strong>这里是一个疑惑点</strong>：为什么需要二次检查线程池的运行状态，当前工作线程数量为0，尝试创建一个非核心线程并且传入的任务对象为null？这个可以看API注释：</p>
<blockquote>
<p>如果一个任务成功加入任务队列，我们依然需要二次检查是否需要添加一个工作线程（因为所有存活的工作线程有可能在最后一次检查之后已经终结）或者执行当前方法的时候线程池是否已经shutdown了。所以我们需要二次检查线程池的状态，必须时把任务从任务队列中移除或者在没有可用的工作线程的前提下新建一个工作线程。</p>
</blockquote>
<h2 id="addWorker方法源码分析"><a href="#addWorker方法源码分析" class="headerlink" title="addWorker方法源码分析"></a>addWorker方法源码分析</h2><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//检验线程池状态和线程池数量边界，通过校验则新增一个线程到线程池中</span></span><br><span class="line"><span class="hljs-comment">//firstTask是新创建的worker第一次要执行的。</span></span><br><span class="line"><span class="hljs-comment">//当线程数量少于corePoolSize线程或队列已满（这种情况下需要绕过队列），firstTask不为空</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">addWorker</span><span class="hljs-params">(Runnable firstTask, <span class="hljs-keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">        retry:</span><br><span class="line">        <span class="hljs-keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="hljs-keyword">int</span> c = ctl.get();</span><br><span class="line">            <span class="hljs-comment">//获取线程池状态</span></span><br><span class="line">            <span class="hljs-keyword">int</span> rs = runStateOf(c);</span><br><span class="line">            <span class="hljs-comment">//这个判断是线程池拒绝任务的逻辑，比较绕，包含如下两个逻辑</span></span><br><span class="line">            <span class="hljs-comment">//1、线程池状态不再是RUNNING则拒绝创建worker</span></span><br><span class="line">            <span class="hljs-comment">//2、线程池状态如果是SHUTDOWN并且firstTask为Null且任务队列中有其他任务则拒绝新的任务</span></span><br><span class="line">            <span class="hljs-comment">//其实这个判定的具体业务时：在线程池状态为STOP，TIDYING,TERMINATED状态下，不会再接受新的任务。如果状态是SHUTDOWN，firstTask为空并且workQueue不为空，则可以创建新的工作线程。当队列为空了，就不能继续提交任务了。</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">                ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">                   firstTask == <span class="hljs-keyword">null</span> &amp;&amp;</span><br><span class="line">                   ! workQueue.isEmpty()))</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">            <span class="hljs-comment">//自旋检测状态</span></span><br><span class="line">            <span class="hljs-keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="hljs-comment">//获取worker的数量</span></span><br><span class="line">                <span class="hljs-keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">                <span class="hljs-comment">//判定数量是否大于边界，大于的话则拒绝新建线程</span></span><br><span class="line">                <span class="hljs-keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                    wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">                <span class="hljs-comment">//CAS增加工作线程数量</span></span><br><span class="line">                <span class="hljs-keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                    <span class="hljs-keyword">break</span> retry;</span><br><span class="line">                <span class="hljs-comment">//如果CAS失败，则需要再次读取ctl</span></span><br><span class="line">                c = ctl.get();  <span class="hljs-comment">// Re-read ctl</span></span><br><span class="line">                <span class="hljs-keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                    <span class="hljs-keyword">continue</span> retry;</span><br><span class="line">                <span class="hljs-comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">boolean</span> workerStarted = <span class="hljs-keyword">false</span>;</span><br><span class="line">        <span class="hljs-keyword">boolean</span> workerAdded = <span class="hljs-keyword">false</span>;</span><br><span class="line">        Worker w = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-comment">//创建工作线程</span></span><br><span class="line">            w = <span class="hljs-keyword">new</span> Worker(firstTask);</span><br><span class="line">            <span class="hljs-keyword">final</span> Thread t = w.thread;</span><br><span class="line">            <span class="hljs-keyword">if</span> (t != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                <span class="hljs-comment">//获取全局锁</span></span><br><span class="line">                <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;</span><br><span class="line">                mainLock.lock();</span><br><span class="line">                <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                    <span class="hljs-comment">// Recheck while holding lock.</span></span><br><span class="line">                    <span class="hljs-comment">// Back out on ThreadFactory failure or if</span></span><br><span class="line">                    <span class="hljs-comment">// shut down before lock acquired.</span></span><br><span class="line">                    <span class="hljs-comment">//获取全局锁之后再次校验避免线程池shutdown</span></span><br><span class="line">                    <span class="hljs-keyword">int</span> rs = runStateOf(ctl.get());</span><br><span class="line">                    <span class="hljs-comment">//线程池状态是RUNNING或者状态是SHUTDOWN但是core已满且队列未满</span></span><br><span class="line">                    <span class="hljs-keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                        (rs == SHUTDOWN &amp;&amp; firstTask == <span class="hljs-keyword">null</span>)) &#123;</span><br><span class="line">                        <span class="hljs-keyword">if</span> (t.isAlive()) <span class="hljs-comment">// precheck that t is startable</span></span><br><span class="line">                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalThreadStateException();</span><br><span class="line">                        <span class="hljs-comment">//把线程添加进workers容器中</span></span><br><span class="line">                        workers.add(w);</span><br><span class="line">                        <span class="hljs-keyword">int</span> s = workers.size();</span><br><span class="line">                        <span class="hljs-keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                            largestPoolSize = s;</span><br><span class="line">                        workerAdded = <span class="hljs-keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                    mainLock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="hljs-comment">//如果worker添加完毕，则需要启动线程</span></span><br><span class="line">                <span class="hljs-keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                    t.start();</span><br><span class="line">                    workerStarted = <span class="hljs-keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (! workerStarted)</span><br><span class="line">                addWorkerFailed(w);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> workerStarted;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>addWorker</code>方法，得出一个很重要的结论</p>
<blockquote>
<p>线程池状态 &gt; SHUTDOWN时（即为STOP，TIDYING，TERMINATED这三种），线程池会拒绝所有的新提交任务。</p>
<p>线程池状态为SHUTDOWN的时候，并不会拒绝全部的任务，只会拒绝firstTask不为空，或者firstTask为空并且workQueue为空。其中firstTask是一个关键点，在工作线程数量小于coreSize或者队列满并且线程数量没有达到maxSize时，firstTask不为空。</p>
<p>所以基于以上分析，当调用threadPool.shutdown()之后，核心线程是提交不进来的，队列满之后的临时线程也提交不进来，只有队列不为空的情况下才能提交进来，直到队列中的任务被全部处理完毕，所有线程就都提交不进来了。</p>
</blockquote>
<h2 id="工作线程内部类Worker源码分析"><a href="#工作线程内部类Worker源码分析" class="headerlink" title="工作线程内部类Worker源码分析"></a>工作线程内部类Worker源码分析</h2><p>可以看到<code>Worker</code>实现了<code>AQS</code>，实现AQS的目的也是为了保证工作线程内部的线程安全和<code>shutdown</code>时判定工作线程是否在工作中。</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Worker</span></span></span><br><span class="line"><span class="hljs-class">        <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueuedSynchronizer</span></span></span><br><span class="line"><span class="hljs-class">        <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span></span></span><br><span class="line"><span class="hljs-class">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Thread thread;</span><br><span class="line">        Runnable firstTask;</span><br><span class="line">        <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">long</span> completedTasks;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * 默认构造函数</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        Worker(Runnable firstTask) &#123;</span><br><span class="line">            <span class="hljs-comment">//设置state初始值为-1，阻止中断工作线程</span></span><br><span class="line">            setState(-<span class="hljs-number">1</span>);</span><br><span class="line">            <span class="hljs-keyword">this</span>.firstTask = firstTask;</span><br><span class="line">            <span class="hljs-comment">//线程是通过线程工厂创建的.</span></span><br><span class="line">            <span class="hljs-keyword">this</span>.thread = getThreadFactory().newThread(<span class="hljs-keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-comment">//下文重点讲解</span></span><br><span class="line">            runWorker(<span class="hljs-keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// Lock methods</span></span><br><span class="line">        <span class="hljs-comment">//</span></span><br><span class="line">        <span class="hljs-comment">// The value 0 represents the unlocked state.</span></span><br><span class="line">        <span class="hljs-comment">// The value 1 represents the locked state.</span></span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isHeldExclusively</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> getState() != <span class="hljs-number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryAcquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryRelease</span><span class="hljs-params">(<span class="hljs-keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">            setExclusiveOwnerThread(<span class="hljs-keyword">null</span>);</span><br><span class="line">            setState(<span class="hljs-number">0</span>);</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span>        </span>&#123; acquire(<span class="hljs-number">1</span>); &#125;</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span>  </span>&#123; <span class="hljs-keyword">return</span> tryAcquire(<span class="hljs-number">1</span>); &#125;</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span>      </span>&#123; release(<span class="hljs-number">1</span>); &#125;</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isLocked</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> isHeldExclusively(); &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">interruptIfStarted</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            Thread t;</span><br><span class="line">            <span class="hljs-keyword">if</span> (getState() &gt;= <span class="hljs-number">0</span> &amp;&amp; (t = thread) != <span class="hljs-keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class="line">                <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                    t.interrupt();</span><br><span class="line">                &#125; <span class="hljs-keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="runWorker源码分析"><a href="#runWorker源码分析" class="headerlink" title="runWorker源码分析"></a>runWorker源码分析</h2><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//自旋的从队列中获取任务并执行</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">runWorker</span><span class="hljs-params">(Worker w)</span> </span>&#123;</span><br><span class="line">    Thread wt = Thread.currentThread();</span><br><span class="line">    Runnable task = w.firstTask;</span><br><span class="line">    w.firstTask = <span class="hljs-keyword">null</span>;</span><br><span class="line">    w.unlock(); <span class="hljs-comment">// 允许中断线程</span></span><br><span class="line">    <span class="hljs-comment">//突然停止标识位</span></span><br><span class="line">    <span class="hljs-keyword">boolean</span> completedAbruptly = <span class="hljs-keyword">true</span>;</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">        <span class="hljs-comment">//task不为空或者从队列中获取task，如果队列为空则阻塞while</span></span><br><span class="line">        <span class="hljs-keyword">while</span> (task != <span class="hljs-keyword">null</span> || (task = getTask()) != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-comment">//</span></span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="hljs-comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">            <span class="hljs-comment">// 如果线程池正在停止（STOPING），请确保线程是中断的。</span></span><br><span class="line">            <span class="hljs-comment">// 否则，要确保线程不是中断的</span></span><br><span class="line">            <span class="hljs-keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &amp;&amp;</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                <span class="hljs-comment">//钩子方法，在执行任务前执行</span></span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                Throwable thrown = <span class="hljs-keyword">null</span>;</span><br><span class="line">                <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                    <span class="hljs-comment">//执行任务，此处调用应用实现代码</span></span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="hljs-keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                    thrown = x; <span class="hljs-keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="hljs-keyword">catch</span> (Error x) &#123;</span><br><span class="line">                    thrown = x; <span class="hljs-keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="hljs-keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                    thrown = x; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(x);</span><br><span class="line">                &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                    <span class="hljs-comment">//钩子方法，在任务执行之后执行</span></span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                task = <span class="hljs-keyword">null</span>;</span><br><span class="line">                <span class="hljs-comment">//递增completedTasks，由于worker.lock，所以这个递增是安全的</span></span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completedAbruptly = <span class="hljs-keyword">false</span>;</span><br><span class="line">    &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">        <span class="hljs-comment">//</span></span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processWorkerExit</span><span class="hljs-params">(Worker w, <span class="hljs-keyword">boolean</span> completedAbruptly)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (completedAbruptly) <span class="hljs-comment">// If abrupt, then workerCount wasn't adjusted</span></span><br><span class="line">      decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">      completedTaskCount += w.completedTasks;</span><br><span class="line">      workers.remove(w);</span><br><span class="line">    &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">      mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tryTerminate();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="hljs-keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">      <span class="hljs-keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">        <span class="hljs-keyword">int</span> min = allowCoreThreadTimeOut ? <span class="hljs-number">0</span> : corePoolSize;</span><br><span class="line">        <span class="hljs-keyword">if</span> (min == <span class="hljs-number">0</span> &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">          min = <span class="hljs-number">1</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">          <span class="hljs-keyword">return</span>; <span class="hljs-comment">// replacement not needed</span></span><br><span class="line">      &#125;</span><br><span class="line">      addWorker(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://syxtt.xin/image/blog/runWorker.jpg" alt="runWorker执行过程"></p>
<h2 id="getTask方法源码分析"><a href="#getTask方法源码分析" class="headerlink" title="getTask方法源码分析"></a>getTask方法源码分析</h2><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//getTask返回NULL代表工作线程将要终止</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> Runnable <span class="hljs-title">getTask</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">  <span class="hljs-comment">//记录上次一poll时是否超时</span></span><br><span class="line">  <span class="hljs-keyword">boolean</span> timedOut = <span class="hljs-keyword">false</span>; <span class="hljs-comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="hljs-comment">//获取线程池状态</span></span><br><span class="line">    <span class="hljs-keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//线程池状态为SHUTDOWN时，如果工作队列为空，则decrementWorkerCount，返回NULL</span></span><br><span class="line">    <span class="hljs-comment">//线程池状态大于SHUTDOWN时，decrementWorkerCount,返回NULL</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">      <span class="hljs-comment">//原子的减少线程池数量，ctl低29位</span></span><br><span class="line">      decrementWorkerCount();</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// 获取工作线程数量</span></span><br><span class="line">    <span class="hljs-comment">// 到这里说明线程池还处于RUNNING状态</span></span><br><span class="line">    <span class="hljs-keyword">int</span> wc = workerCountOf(c);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 允许core线程超时或者线程数量大于coreSize</span></span><br><span class="line">    <span class="hljs-keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line">    <span class="hljs-comment">// </span></span><br><span class="line">    <span class="hljs-keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">        &amp;&amp; (wc &gt; <span class="hljs-number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">      <span class="hljs-keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">      <span class="hljs-keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">      Runnable r = timed ?</span><br><span class="line">        workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">      workQueue.take();</span><br><span class="line">      <span class="hljs-comment">// 只有非null的时候才返回，null的情况下会进入下一轮循环</span></span><br><span class="line">      <span class="hljs-keyword">if</span> (r != <span class="hljs-keyword">null</span>)</span><br><span class="line">        <span class="hljs-keyword">return</span> r;</span><br><span class="line">      timedOut = <span class="hljs-keyword">true</span>;</span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">      timedOut = <span class="hljs-keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法中，有两处十分庞大的<code>if</code>逻辑，对于第一处<code>if</code>可能导致工作线程数减去1直接返回<code>null</code>的场景有：</p>
<ol>
<li>线程池状态为<code>SHUTDOWN</code>，一般是调用了<code>shutdown()</code>方法，并且任务队列为空。</li>
<li>线程池状态为<code>STOP</code>。</li>
</ol>
<p>对于第二处<code>if</code>，逻辑有点复杂，先拆解一下：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">复制<span class="hljs-comment">// 工作线程总数大于maximumPoolSize，说明了通过setMaximumPoolSize()方法减少了线程池容量</span></span><br><span class="line"><span class="hljs-keyword">boolean</span> b1 = wc &gt; maximumPoolSize;</span><br><span class="line"><span class="hljs-comment">// 允许线程超时同时上一轮通过poll()方法从任务队列中拉取任务为null</span></span><br><span class="line"><span class="hljs-keyword">boolean</span> b2 = timed &amp;&amp; timedOut;</span><br><span class="line"><span class="hljs-comment">// 工作线程总数大于1</span></span><br><span class="line"><span class="hljs-keyword">boolean</span> b3 = wc &gt; <span class="hljs-number">1</span>;</span><br><span class="line"><span class="hljs-comment">// 任务队列为空</span></span><br><span class="line"><span class="hljs-keyword">boolean</span> b4 = workQueue.isEmpty();</span><br><span class="line"><span class="hljs-keyword">boolean</span> r = (b1 || b2) &amp;&amp; (b3 || b4);</span><br><span class="line"><span class="hljs-keyword">if</span> (r) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (compareAndDecrementWorkerCount(c))&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">    &#125;<span class="hljs-keyword">else</span>&#123;</span><br><span class="line">        <span class="hljs-keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段逻辑大多数情况下是针对非核心线程。在<code>execute()</code>方法中，当线程池总数已经超过了<code>corePoolSize</code>并且还小于<code>maximumPoolSize</code>时，当任务队列已经满了的时候，会通过<code>addWorker(task,false)</code>添加非核心线程。而这里的逻辑恰好类似于<code>addWorker(task,false)</code>的反向操作，用于减少非核心线程，使得工作线程总数趋向于<code>corePoolSize</code>。如果对于非核心线程，上一轮循环获取任务对象为<code>null</code>，这一轮循环很容易满足<code>timed &amp;&amp; timedOut</code>为true，这个时候<code>getTask()</code>返回null会导致<code>Worker#runWorker()</code>方法跳出死循环，之后执行<code>processWorkerExit()</code>方法处理后续工作，而该非核心线程对应的<code>Worker</code>则变成“游离对象”，等待被JVM回收。当<code>allowCoreThreadTimeOut</code>设置为true的时候，这里分析的非核心线程的生命周期终结逻辑同时会适用于核心线程。那么可以总结出<code>keepAliveTime</code>的意义：</p>
<ul>
<li>当允许核心线程超时，也就是<code>allowCoreThreadTimeOut</code>设置为true的时候，此时<code>keepAliveTime</code>表示空闲的工作线程的存活周期。</li>
<li>默认情况下不允许核心线程超时，此时<code>keepAliveTime</code>表示空闲的非核心线程的存活周期。</li>
</ul>
<p>在一些特定的场景下，配置合理的<code>keepAliveTime</code>能够更好地利用线程池的工作线程资源。</p>
<h2 id="processWorkerExit方法源码分析"><a href="#processWorkerExit方法源码分析" class="headerlink" title="processWorkerExit方法源码分析"></a>processWorkerExit方法源码分析</h2><p>processWorkerExit是在工作线程跳出工作队列死循环时，更新线程池数量，线程池容器。</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processWorkerExit</span><span class="hljs-params">(Worker w, <span class="hljs-keyword">boolean</span> completedAbruptly)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">//突然结束，是因为线程抛出用户异常，直接使工作线程数减1</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (completedAbruptly)</span><br><span class="line">      decrementWorkerCount();</span><br><span class="line">		</span><br><span class="line">    <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">      <span class="hljs-comment">//全局锁锁定情况下，线程安全的方式更新完成的任务数量并移除Worker</span></span><br><span class="line">      completedTaskCount += w.completedTasks;</span><br><span class="line">      workers.remove(w);</span><br><span class="line">    &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">      mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">//用于根据当前线程池的状态判断是否需要进行线程池terminate处理</span></span><br><span class="line">    tryTerminate();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="hljs-comment">//如果状态小于STOP，即RUNNING 或 SHUTDOWN</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">      <span class="hljs-comment">//并且不是线程抛出用户异常</span></span><br><span class="line">      <span class="hljs-keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">        <span class="hljs-keyword">int</span> min = allowCoreThreadTimeOut ? <span class="hljs-number">0</span> : corePoolSize;</span><br><span class="line">        <span class="hljs-comment">//如果允许核心线程超时且队列不为空，则至少保证一个工作线程</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (min == <span class="hljs-number">0</span> &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">          min = <span class="hljs-number">1</span>;</span><br><span class="line">        <span class="hljs-comment">//工作线程大于等于最小值，直接返回不新增非核心线程</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">          <span class="hljs-keyword">return</span>; <span class="hljs-comment">// replacement not needed</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="hljs-comment">//工作线程小于最小值，需要新增非核心线程</span></span><br><span class="line">      addWorker(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="tryTerminate方法源码分析"><a href="#tryTerminate方法源码分析" class="headerlink" title="tryTerminate方法源码分析"></a>tryTerminate方法源码分析</h2><p>每个工作线程在工作结束之后都会调用<code>tryTerminate</code>方法，总结为：</p>
<blockquote>
<p>满足两种情况就会把线程池状态置为TERMINATED<br>1、状态为SHUTDOWN切队列数量为0，工作线程数量为0，对应shutdown关闭的情况<br>2、状态为STOP且工作线程数量为0，对应shutdownNow关闭的情况</p>
</blockquote>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//满足两种情况就会把线程池状态置为TERMINATED</span></span><br><span class="line"><span class="hljs-comment">//1、状态为SHUTDOWN切队列数量为0，工作线程数量为0，对应shutdown关闭的情况</span></span><br><span class="line"><span class="hljs-comment">//2、状态为STOP且工作线程数量为0，对应shutdownNow关闭的情况</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tryTerminate</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="hljs-keyword">int</span> c = ctl.get();</span><br><span class="line">      <span class="hljs-comment">//1、线程池状态是RUNNING，不做任何操作直接返回</span></span><br><span class="line">      <span class="hljs-comment">//2、线程池状态是TIDYING，不做任何操作直接返回</span></span><br><span class="line">      <span class="hljs-comment">//3、线程池状态是SHUTDOWN，且队列不为空不做任何操作直接返回</span></span><br><span class="line">      <span class="hljs-keyword">if</span> (isRunning(c) ||</span><br><span class="line">          runStateAtLeast(c, TIDYING) ||</span><br><span class="line">          (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">      <span class="hljs-comment">// 工作线程数不为0，则中断工作线程集合中的第一个空闲的工作线程</span></span><br><span class="line">      <span class="hljs-keyword">if</span> (workerCountOf(c) != <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// Eligible to terminate</span></span><br><span class="line">        interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;</span><br><span class="line">      mainLock.lock();</span><br><span class="line">      <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">        <span class="hljs-comment">//CAS设置状态为TIDYING状态</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="hljs-number">0</span>))) &#123;</span><br><span class="line">          <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-comment">//执行terminated方法</span></span><br><span class="line">            terminated();</span><br><span class="line">          &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">            <span class="hljs-comment">//执行terminated方法完毕之后，设置线程池状态为TERMINATED</span></span><br><span class="line">            ctl.set(ctlOf(TERMINATED, <span class="hljs-number">0</span>));</span><br><span class="line">            <span class="hljs-comment">// 唤醒阻塞在termination条件的所有线程，这个变量的await()方法在awaitTermination()中调用</span></span><br><span class="line">            termination.signalAll();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="hljs-keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="hljs-comment">// else retry on failed CAS</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//中断空闲的工作线程，以便它们可以检查终止或配置更改</span></span><br><span class="line"><span class="hljs-comment">//如果onlyOne未true，中断最多一个线程。</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">interruptIdleWorkers</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> onlyOne)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">for</span> (Worker w : workers) &#123;</span><br><span class="line">        Thread t = w.thread;</span><br><span class="line">        <span class="hljs-comment">// 这里判断线程不是中断状态并且尝试获取锁成功的时候才进行线程中断</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class="line">          <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            t.interrupt();</span><br><span class="line">          &#125; <span class="hljs-keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">          &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">            w.unlock();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> (onlyOne)</span><br><span class="line">          <span class="hljs-keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">      mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关闭线程池方法源码分析"><a href="#关闭线程池方法源码分析" class="headerlink" title="关闭线程池方法源码分析"></a>关闭线程池方法源码分析</h2><p>首先和关闭线程池相关的方法有三个<code>shutdown()</code>，<code>shutdownNow()</code>，<code>awaitTermination(long timeout, TimeUnit unit)</code></p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//已提交的任务还会继续执行，但是新的任务将被拒绝,shutdown不会影响用户的正常使用 </span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shutdown</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;</span><br><span class="line">     mainLock.lock();</span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">       <span class="hljs-comment">//校验权限，安全策略 SecurityManager</span></span><br><span class="line">       checkShutdownAccess();</span><br><span class="line">       <span class="hljs-comment">//CAS更新状态为SHUTDOWN</span></span><br><span class="line">       advanceRunState(SHUTDOWN);</span><br><span class="line">       <span class="hljs-comment">//中断所有空闲的工作线程</span></span><br><span class="line">       interruptIdleWorkers();</span><br><span class="line">       <span class="hljs-comment">//钩子方法</span></span><br><span class="line">       onShutdown(); <span class="hljs-comment">// hook for ScheduledThreadPoolExecutor</span></span><br><span class="line">     &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">       mainLock.unlock();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-comment">//尝试把线程池状态置为TERMINATED</span></span><br><span class="line">     tryTerminate();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Runnable&gt; <span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">      <span class="hljs-comment">//校验权限，安全策略 SecurityManager</span></span><br><span class="line">      checkShutdownAccess();</span><br><span class="line">      <span class="hljs-comment">//CAS更新状态为STOP</span></span><br><span class="line">      advanceRunState(STOP);</span><br><span class="line">      <span class="hljs-comment">//中断所有空闲的工作线程</span></span><br><span class="line">      interruptWorkers();</span><br><span class="line">      <span class="hljs-comment">//清空工作队列，并返回未执行的任务列表</span></span><br><span class="line">      tasks = drainQueue();</span><br><span class="line">    &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">      mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">//尝试把线程池状态置为TERMINATED</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="hljs-comment">//返回任务列表</span></span><br><span class="line">    <span class="hljs-keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">awaitTermination</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="hljs-function">    <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">    <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="hljs-comment">//如果发现状态已经变成TERMINATED，则返回true</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (runStateAtLeast(ctl.get(), TERMINATED))</span><br><span class="line">          <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (nanos &lt;= <span class="hljs-number">0</span>)</span><br><span class="line">          <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">        <span class="hljs-comment">//阻塞直到超时，如果未超时，tryTerminate会signalAll，这时停止阻塞</span></span><br><span class="line">        nanos = termination.awaitNanos(nanos);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">      <span class="hljs-comment">//释放全局锁</span></span><br><span class="line">      mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>总结下这三个终止线程池的方法，shutdown()和shutdownNow()是中断所有<strong>空闲工作线程</strong>，如果线程在执行<code>Runnable#run()</code>，那么这个工作线程是不会被中断的，而是等待下一轮执行<code>getTask()</code>方法的时候，通过线程池状态判断正常终结该工作线程。</p>
<p><code>awaitTermination</code>很容易被忽略，因为对线程池状态不了解的人，是不会第一时间想到这个方法的作用的。它的好处是调用改方法的线程会阻塞直到线程状态更新为<code>TERMINATED</code>才返回，某些需要感知线程池终止的场景需要调用该方法来终止线程池。</p>
</blockquote>
<h2 id="reject方法源码分析"><a href="#reject方法源码分析" class="headerlink" title="reject方法源码分析"></a>reject方法源码分析</h2><p>拒绝方法的实现很简单了，就是一个回调函数，具体的拒绝策略需要应用者来实现。</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reject</span><span class="hljs-params">(Runnable command)</span> </span>&#123;</span><br><span class="line">    handler.rejectedExecution(command, <span class="hljs-keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="场景举例"><a href="#场景举例" class="headerlink" title="场景举例"></a>场景举例</h1><p>通过对<code>ThreadPoolExecutor</code>的核心流程和源码的研究，相信大家对它的设计思想和实现原理有了一定的掌握，接下来需要结合实际场景分析下，本文整理了几个景点的场景，分析一下具体的流程，进一步加深理解。</p>
<ul>
<li><p>场景1：<strong>线程池刚刚创建，第一次submit(Task)，然后执行<code>Futrue.get()</code>等待执行结果。</strong></p>
<p>此刻线程池状态是<code>RUNNING</code>，工作线程数量为零，其数量肯定小于<code>corePoolSize</code>，提交的任务会交给核心线程，且firstTask不为空。工作线程创建好之后，会立即<code>start()</code>，线程开始执行<code>runWorker</code>函数，<code>runWorker</code>中会判断线程的状态不是<code>STOP</code>，这时会执行任务对象的<code>run()</code>(一般情况下是Callable接口的run，Callable接口的run又调用了真正的用户执行逻辑)。在工作线程执行完毕之后，<code>Callable</code>的结果赋值给<code>FutrueTask.outcome</code>且<code>FutrueTask.status == COMPLETING</code>，<code>Futrue.get()</code>解除阻塞，结果返回。</p>
</li>
<li><p>场景2：<strong>线程池工作线程数量等于<code>corePoolSize</code>，队列未满，这时submit(Task)，然后执行<code>Futrue.get()</code>等待执行结果。</strong></p>
<p>此刻线程池状态是<code>RUNNING</code>，工作线程数量等于<code>corePoolSize</code>，提交的任务会加入到阻塞队列中。工作线程们“嗷嗷待哺”（阻塞在队列上），这时会有一个工作线程争抢到食物（Task），剩下的流程同场景1。</p>
</li>
<li><p>场景3：<strong>线程池工作线程等于<code>corePoolSize</code>，工作队列已满，这时submit(Task)，然后执行<code>Futrue.get()</code>等待执行结果。</strong></p>
<p>此刻线程池状态是<code>RUNNING</code>，由于队列已满，需要加入非核心线程来执行任务，<strong>非核心线程数量=maximumPoolSize - corePoolSize</strong>，加入新的工作线程且firstTask不为空。剩下的执行流程同场景1。</p>
</li>
<li><p>场景4：执行<code>shutdown()</code>操作。</p>
<p>在执行<code>shutdown()</code>之后，首先进行安全性检查，并将线程池状态设置为<code>SHUTDOWN</code>，<strong>中断未执行的线程（通过tryLock可知，在执行的线程是被锁定的），执行中的线程不中断</strong>。线程一旦中断，阻塞在队列<code>take()</code>方法或者<code>poll()</code>方法就会抛出<code>InteruptException</code>，<code>getTask()</code>方法内部的自旋重启，因为此刻线程池状态是<code>SHUTDOWN</code>，如果工作队列为空，就直接返回null；如果工作队列不为空，则继续<code>take()</code>出任务交给工作线程执行，知道队列为空，返回null，逐步使工作线程进入<code>Terminated</code>状态。在执行<code>shutdown</code>之后，所有的新提交任务，都会被拒绝，已提交的任务会等待执行完毕。最终线程池状态会变为<code>TERMINATED</code>,如果想获取到线程池终结的事件，需要调用awaitTermination`方法。</p>
</li>
<li><p>场景4：执行<code>shutdownNow()</code>操作。</p>
<p>在执行<code>shutdownNow()</code>之后，首先进行安全性检查，并将线程池状态设置为<code>STOP</code>，<strong>中断所有工作线程（不论工作线程是否在工作中），并移除工作队列中全部的任务，返回给用户自行处置</strong>。由于工作线程全部中断，阻塞在队列<code>take()</code>方法或者<code>poll()</code>方法就会抛出<code>InteruptException</code>，<code>getTask()</code>方法内部的自旋重启，因为此刻线程池状态是<code>STOP</code>，就直接返回null，跳出死循环，等待工作线程<code>Terminated</code>，最后返回所有的工作队列中未执行的任务。在执行<code>shutdownNow</code>之后，所有的新提交任务，都会被拒绝，未执行的任务会返回给用户自行处理，在执行中的任务虽然工作线程已经被中断，除非任务中处理了中断状态，否则不影响任务执行。</p>
</li>
</ul>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p><code>ThreadPoolExecutor</code>作为Java并发编程中最常使用的工作类，研究其实现原理不仅能够熟练运用线程池写出高效的并发代码，避免采坑之外，还能够发掘作者再创作过程中的“点睛之笔”。</p>
<p><code>ThreadPoolExecutor</code>中，大量运用了位计算来提高性能，线程池的状态和工作线程的数量，都交给一个32位的<code>ctl</code>变量控制，通过把<code>线程</code>抽象为<code>Worker</code>和全局锁<code>mainLock</code>，来保证工作线程执行任务的线程安全，巧妙的运用阻塞队列，来避免线程数量暴增，并通过<code>中断</code>来控制工作线程阻塞与否，线程的终止过程，即可“温和”也可“粗暴”，整个线程池设计精妙，应用者使用如丝般顺滑。</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="http://www.throwable.club/2019/07/15/java-concurrency-thread-pool-executor/" target="_blank" rel="noopener">JUC线程池ThreadPoolExecutor源码分析</a></p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/Java并发-线程池-JUC-ThreadPoolExecutor/">Java并发 - 线程池 - JUC - ThreadPoolExecutor</a>
                </div>
            </div>
        </div>
        
        
        
        <div class="social-share"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
                
<a class="button is-success donate">
    <span class="icon is-small">
        <i class="fab fa-weixin"></i>
    </span>
    <span>微信</span>
    <div class="qrcode"><img src="http://syxtt.xin/WechatIMG4.jpeg" alt="微信"></div>
</a>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2020/01/20/elk/Elastic-APM实战/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">Elastic APM实战</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2019/12/13/distributed/分布式系统分片方法研究/">
                <span class="level-item">分布式系统分片方法研究</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
 <div id="gitment-container"></div>
 <link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
 <script src="https://billts.site/js/gitment.js"></script>
 <script>
 var gitment = new Gitment({
 	id: 'bb4d75b10706b839f69b7948a78e969f',
     owner: 'siyuanWang',
     repo: 'blog_issue',
     oauth: {
         client_id: 'e3e1d2680a4935081163',
         client_secret: '364eb18119bda5afd5daa7c6fa7129c792c36650',
     },
 });
 gitment.render('gitment-container');
 </script>


    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="http://syxtt.xin/image/blog/logo/%E5%8D%9A%E5%AE%A2Logo.jpg" alt="Mr.Crowley">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        Mr.Crowley
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        搜索架构师，微服务架构师
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>中国 北京</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        58
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        8
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        68
                    </p>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/siyuanWang" target="_blank">
                关注我</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Github" href="https://github.com/siyuanWang">
                
                <i class="fab fa-github"></i>
                
            </a>
            
        </div>
        
    </div>
</div>

    
        

    <div class="card widget" id="toc">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    目录
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#前言">
        <span class="has-mr-6">1</span>
        <span>前言</span>
        </a></li><li>
        <a class="is-flex" href="#提出问题">
        <span class="has-mr-6">2</span>
        <span>提出问题</span>
        </a></li><li>
        <a class="is-flex" href="#前置知识复习">
        <span class="has-mr-6">3</span>
        <span>前置知识复习</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#线程状态">
        <span class="has-mr-6">3.1</span>
        <span>线程状态</span>
        </a></li><li>
        <a class="is-flex" href="#线程池的作用">
        <span class="has-mr-6">3.2</span>
        <span>线程池的作用</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#ThreadPoolExecutor的原理">
        <span class="has-mr-6">4</span>
        <span>ThreadPoolExecutor的原理</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#类的设计">
        <span class="has-mr-6">4.1</span>
        <span>类的设计</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#Executor">
        <span class="has-mr-6">4.1.1</span>
        <span>Executor</span>
        </a></li><li>
        <a class="is-flex" href="#ExecutorService">
        <span class="has-mr-6">4.1.2</span>
        <span>ExecutorService</span>
        </a></li><li>
        <a class="is-flex" href="#Futrue">
        <span class="has-mr-6">4.1.3</span>
        <span>Futrue</span>
        </a></li><li>
        <a class="is-flex" href="#AbstractExecutorService">
        <span class="has-mr-6">4.1.4</span>
        <span>AbstractExecutorService</span>
        </a></li><li>
        <a class="is-flex" href="#ThreadPoolExecutor">
        <span class="has-mr-6">4.1.5</span>
        <span>ThreadPoolExecutor</span>
        </a></li><li>
        <a class="is-flex" href="#总结">
        <span class="has-mr-6">4.1.6</span>
        <span>总结</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#线程池状态">
        <span class="has-mr-6">4.2</span>
        <span>线程池状态</span>
        </a></li><li>
        <a class="is-flex" href="#核心流程">
        <span class="has-mr-6">4.3</span>
        <span>核心流程</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#任务提交核心流程">
        <span class="has-mr-6">4.3.1</span>
        <span>任务提交核心流程</span>
        </a></li><li>
        <a class="is-flex" href="#创建工作线程核心流程">
        <span class="has-mr-6">4.3.2</span>
        <span>创建工作线程核心流程</span>
        </a></li><li>
        <a class="is-flex" href="#任务执行核心流程">
        <span class="has-mr-6">4.3.3</span>
        <span>任务执行核心流程</span>
        </a></li><li>
        <a class="is-flex" href="#线程池关闭核心流程">
        <span class="has-mr-6">4.3.4</span>
        <span>线程池关闭核心流程</span>
        </a></li></ul></li></ul></li><li>
        <a class="is-flex" href="#ThreadPoolExecutor源码分析">
        <span class="has-mr-6">5</span>
        <span>ThreadPoolExecutor源码分析</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#关键属性">
        <span class="has-mr-6">5.1</span>
        <span>关键属性</span>
        </a></li><li>
        <a class="is-flex" href="#状态控制">
        <span class="has-mr-6">5.2</span>
        <span>状态控制</span>
        </a></li><li>
        <a class="is-flex" href="#核心方法总体概括">
        <span class="has-mr-6">5.3</span>
        <span>核心方法总体概括</span>
        </a></li><li>
        <a class="is-flex" href="#execute方法源码分析">
        <span class="has-mr-6">5.4</span>
        <span>execute方法源码分析</span>
        </a></li><li>
        <a class="is-flex" href="#addWorker方法源码分析">
        <span class="has-mr-6">5.5</span>
        <span>addWorker方法源码分析</span>
        </a></li><li>
        <a class="is-flex" href="#工作线程内部类Worker源码分析">
        <span class="has-mr-6">5.6</span>
        <span>工作线程内部类Worker源码分析</span>
        </a></li><li>
        <a class="is-flex" href="#runWorker源码分析">
        <span class="has-mr-6">5.7</span>
        <span>runWorker源码分析</span>
        </a></li><li>
        <a class="is-flex" href="#getTask方法源码分析">
        <span class="has-mr-6">5.8</span>
        <span>getTask方法源码分析</span>
        </a></li><li>
        <a class="is-flex" href="#processWorkerExit方法源码分析">
        <span class="has-mr-6">5.9</span>
        <span>processWorkerExit方法源码分析</span>
        </a></li><li>
        <a class="is-flex" href="#tryTerminate方法源码分析">
        <span class="has-mr-6">5.10</span>
        <span>tryTerminate方法源码分析</span>
        </a></li><li>
        <a class="is-flex" href="#关闭线程池方法源码分析">
        <span class="has-mr-6">5.11</span>
        <span>关闭线程池方法源码分析</span>
        </a></li><li>
        <a class="is-flex" href="#reject方法源码分析">
        <span class="has-mr-6">5.12</span>
        <span>reject方法源码分析</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#场景举例">
        <span class="has-mr-6">6</span>
        <span>场景举例</span>
        </a></li><li>
        <a class="is-flex" href="#总结-1">
        <span class="has-mr-6">7</span>
        <span>总结</span>
        </a></li><li>
        <a class="is-flex" href="#参考文档">
        <span class="has-mr-6">8</span>
        <span>参考文档</span>
        </a></li></ul>
            </div>
        </div>
    </div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/ELK/">
            <span class="level-start">
                <span class="level-item">ELK</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">20</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/SpringCloud/">
            <span class="level-start">
                <span class="level-item">SpringCloud</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">12</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/大数据技术/">
            <span class="level-start">
                <span class="level-item">大数据技术</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/开发工具/">
            <span class="level-start">
                <span class="level-item">开发工具</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/搜索/">
            <span class="level-start">
                <span class="level-item">搜索</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">13</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/机器学习/">
            <span class="level-start">
                <span class="level-item">机器学习</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/软件架构/">
            <span class="level-start">
                <span class="level-item">软件架构</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/6entinel/" style="font-size: 10px;">6entinel</a> <a href="/tags/APM/" style="font-size: 11.43px;">APM</a> <a href="/tags/APR/" style="font-size: 10px;">APR</a> <a href="/tags/AQS/" style="font-size: 10px;">AQS</a> <a href="/tags/Apollo/" style="font-size: 10px;">Apollo</a> <a href="/tags/BM25/" style="font-size: 10px;">BM25</a> <a href="/tags/ElasticAPM/" style="font-size: 11.43px;">ElasticAPM</a> <a href="/tags/ElasticSearch/" style="font-size: 18.57px;">ElasticSearch</a> <a href="/tags/Embedded-Tomcat/" style="font-size: 10px;">Embedded Tomcat</a> <a href="/tags/HAProxy/" style="font-size: 10px;">HAProxy</a> <a href="/tags/Hbase/" style="font-size: 17.14px;">Hbase</a> <a href="/tags/IK/" style="font-size: 10px;">IK</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Java并发-线程池-JUC-ThreadPoolExecutor/" style="font-size: 10px;">Java并发 - 线程池 - JUC - ThreadPoolExecutor</a> <a href="/tags/LTR/" style="font-size: 10px;">LTR</a> <a href="/tags/LVS/" style="font-size: 10px;">LVS</a> <a href="/tags/Lambda/" style="font-size: 10px;">Lambda</a> <a href="/tags/Lock/" style="font-size: 10px;">Lock</a> <a href="/tags/MGR/" style="font-size: 10px;">MGR</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/ReentrantLock/" style="font-size: 10px;">ReentrantLock</a> <a href="/tags/ReentrantReadWriteLock/" style="font-size: 10px;">ReentrantReadWriteLock</a> <a href="/tags/Spring/" style="font-size: 17.14px;">Spring</a> <a href="/tags/Spring-Boot/" style="font-size: 12.86px;">Spring Boot</a> <a href="/tags/Spring-Cloud/" style="font-size: 15.71px;">Spring Cloud</a> <a href="/tags/Spring-Cloud-Gateway/" style="font-size: 17.14px;">Spring Cloud Gateway</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/TF-IDF/" style="font-size: 10px;">TF-IDF</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/jmeter/" style="font-size: 10px;">jmeter</a> <a href="/tags/lucene/" style="font-size: 12.86px;">lucene</a> <a href="/tags/range-based/" style="font-size: 10px;">range based</a> <a href="/tags/reactor/" style="font-size: 10px;">reactor</a> <a href="/tags/spring/" style="font-size: 11.43px;">spring</a> <a href="/tags/spring-boot/" style="font-size: 11.43px;">spring-boot</a> <a href="/tags/spring-cloud/" style="font-size: 11.43px;">spring-cloud</a> <a href="/tags/webFlux/" style="font-size: 11.43px;">webFlux</a> <a href="/tags/一致性Hash/" style="font-size: 10px;">一致性Hash</a> <a href="/tags/主从数据库架构/" style="font-size: 10px;">主从数据库架构</a> <a href="/tags/倒排索引/" style="font-size: 10px;">倒排索引</a> <a href="/tags/函数式编程/" style="font-size: 10px;">函数式编程</a> <a href="/tags/分词/" style="font-size: 10px;">分词</a> <a href="/tags/反应式编程/" style="font-size: 14.29px;">反应式编程</a> <a href="/tags/可观察性/" style="font-size: 11.43px;">可观察性</a> <a href="/tags/向量空间模型/" style="font-size: 10px;">向量空间模型</a> <a href="/tags/工厂模式/" style="font-size: 10px;">工厂模式</a> <a href="/tags/工程架构/" style="font-size: 10px;">工程架构</a> <a href="/tags/布尔模型/" style="font-size: 10px;">布尔模型</a> <a href="/tags/并发编程/" style="font-size: 10px;">并发编程</a> <a href="/tags/建造者模式/" style="font-size: 10px;">建造者模式</a> <a href="/tags/开发工具/" style="font-size: 10px;">开发工具</a> <a href="/tags/微服务/" style="font-size: 11.43px;">微服务</a> <a href="/tags/搜索/" style="font-size: 10px;">搜索</a> <a href="/tags/数据分片/" style="font-size: 10px;">数据分片</a> <a href="/tags/相关性/" style="font-size: 10px;">相关性</a> <a href="/tags/线程/" style="font-size: 10px;">线程</a> <a href="/tags/网关/" style="font-size: 12.86px;">网关</a> <a href="/tags/自动部署/" style="font-size: 10px;">自动部署</a> <a href="/tags/虚拟槽/" style="font-size: 10px;">虚拟槽</a> <a href="/tags/设计模式/" style="font-size: 17.14px;">设计模式</a> <a href="/tags/负载均衡/" style="font-size: 10px;">负载均衡</a> <a href="/tags/责任链模式/" style="font-size: 10px;">责任链模式</a> <a href="/tags/配置中心/" style="font-size: 10px;">配置中心</a> <a href="/tags/链路追踪/" style="font-size: 11.43px;">链路追踪</a> <a href="/tags/锁/" style="font-size: 10px;">锁</a>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2020/01/20/elk/Spring Cloud Alibaba集成ElasticAPM/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="http://syxtt.xin/image/blog/elastic-logo-V-full_color.jpg" alt="Spring Cloud Alibaba集成ElasticAPM实战">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-20T11:33:16.000Z">2020-01-20</time></div>
                    <a href="/2020/01/20/elk/Spring Cloud Alibaba集成ElasticAPM/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Spring Cloud Alibaba集成ElasticAPM实战</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/ELK/">ELK</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/01/20/elk/Elastic-APM实战/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="http://syxtt.xin/image/blog/elastic-logo-V-full_color.jpg" alt="Elastic APM实战">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-20T11:33:16.000Z">2020-01-20</time></div>
                    <a href="/2020/01/20/elk/Elastic-APM实战/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Elastic APM实战</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/ELK/">ELK</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/01/09/java/Java并发-ThreadPoolExecutor/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="http://syxtt.xin/线程池图片.jpg" alt="Java并发-ThreadPoolExecutor深度解析">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-09T11:33:16.000Z">2020-01-09</time></div>
                    <a href="/2020/01/09/java/Java并发-ThreadPoolExecutor/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Java并发-ThreadPoolExecutor深度解析</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/12/13/distributed/分布式系统分片方法研究/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="分布式系统分片方法研究">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-13T12:33:16.000Z">2019-12-13</time></div>
                    <a href="/2019/12/13/distributed/分布式系统分片方法研究/" class="title has-link-black-ter is-size-6 has-text-weight-normal">分布式系统分片方法研究</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/软件架构/">软件架构</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/12/12/db/Mysql高可用架构总结/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Mysql高可用架构总结">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-12T12:33:16.000Z">2019-12-12</time></div>
                    <a href="/2019/12/12/db/Mysql高可用架构总结/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Mysql高可用架构总结</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/07/">
                <span class="level-start">
                    <span class="level-item">七月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/6entinel/">
                        <span class="tag">6entinel</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/APM/">
                        <span class="tag">APM</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/APR/">
                        <span class="tag">APR</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/AQS/">
                        <span class="tag">AQS</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Apollo/">
                        <span class="tag">Apollo</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/BM25/">
                        <span class="tag">BM25</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ElasticAPM/">
                        <span class="tag">ElasticAPM</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ElasticSearch/">
                        <span class="tag">ElasticSearch</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Embedded-Tomcat/">
                        <span class="tag">Embedded Tomcat</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HAProxy/">
                        <span class="tag">HAProxy</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Hbase/">
                        <span class="tag">Hbase</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/IK/">
                        <span class="tag">IK</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java并发-线程池-JUC-ThreadPoolExecutor/">
                        <span class="tag">Java并发 - 线程池 - JUC - ThreadPoolExecutor</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/LTR/">
                        <span class="tag">LTR</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/LVS/">
                        <span class="tag">LVS</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Lambda/">
                        <span class="tag">Lambda</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Lock/">
                        <span class="tag">Lock</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MGR/">
                        <span class="tag">MGR</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mysql/">
                        <span class="tag">Mysql</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Nginx/">
                        <span class="tag">Nginx</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ReentrantLock/">
                        <span class="tag">ReentrantLock</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ReentrantReadWriteLock/">
                        <span class="tag">ReentrantReadWriteLock</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring/">
                        <span class="tag">Spring</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring-Boot/">
                        <span class="tag">Spring Boot</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring-Cloud/">
                        <span class="tag">Spring Cloud</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring-Cloud-Gateway/">
                        <span class="tag">Spring Cloud Gateway</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/SpringCloud/">
                        <span class="tag">SpringCloud</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/TF-IDF/">
                        <span class="tag">TF-IDF</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Tomcat/">
                        <span class="tag">Tomcat</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/java/">
                        <span class="tag">java</span>
                        <span class="tag is-grey">13</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/jenkins/">
                        <span class="tag">jenkins</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/jmeter/">
                        <span class="tag">jmeter</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/lucene/">
                        <span class="tag">lucene</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/range-based/">
                        <span class="tag">range based</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/reactor/">
                        <span class="tag">reactor</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/spring/">
                        <span class="tag">spring</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/spring-boot/">
                        <span class="tag">spring-boot</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/spring-cloud/">
                        <span class="tag">spring-cloud</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/webFlux/">
                        <span class="tag">webFlux</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/一致性Hash/">
                        <span class="tag">一致性Hash</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/主从数据库架构/">
                        <span class="tag">主从数据库架构</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/倒排索引/">
                        <span class="tag">倒排索引</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/函数式编程/">
                        <span class="tag">函数式编程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分词/">
                        <span class="tag">分词</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/反应式编程/">
                        <span class="tag">反应式编程</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/可观察性/">
                        <span class="tag">可观察性</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/向量空间模型/">
                        <span class="tag">向量空间模型</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工厂模式/">
                        <span class="tag">工厂模式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工程架构/">
                        <span class="tag">工程架构</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/布尔模型/">
                        <span class="tag">布尔模型</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发编程/">
                        <span class="tag">并发编程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/建造者模式/">
                        <span class="tag">建造者模式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开发工具/">
                        <span class="tag">开发工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/微服务/">
                        <span class="tag">微服务</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/搜索/">
                        <span class="tag">搜索</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据分片/">
                        <span class="tag">数据分片</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/相关性/">
                        <span class="tag">相关性</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线程/">
                        <span class="tag">线程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/网关/">
                        <span class="tag">网关</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/自动部署/">
                        <span class="tag">自动部署</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/虚拟槽/">
                        <span class="tag">虚拟槽</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/负载均衡/">
                        <span class="tag">负载均衡</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/责任链模式/">
                        <span class="tag">责任链模式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/配置中心/">
                        <span class="tag">配置中心</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/链路追踪/">
                        <span class="tag">链路追踪</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/锁/">
                        <span class="tag">锁</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2020/01/20/elk/Spring Cloud Alibaba集成ElasticAPM/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="http://syxtt.xin/image/blog/elastic-logo-V-full_color.jpg" alt="Spring Cloud Alibaba集成ElasticAPM实战">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-20T11:33:16.000Z">2020-01-20</time></div>
                    <a href="/2020/01/20/elk/Spring Cloud Alibaba集成ElasticAPM/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Spring Cloud Alibaba集成ElasticAPM实战</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/ELK/">ELK</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/01/20/elk/Elastic-APM实战/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="http://syxtt.xin/image/blog/elastic-logo-V-full_color.jpg" alt="Elastic APM实战">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-20T11:33:16.000Z">2020-01-20</time></div>
                    <a href="/2020/01/20/elk/Elastic-APM实战/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Elastic APM实战</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/ELK/">ELK</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/01/09/java/Java并发-ThreadPoolExecutor/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="http://syxtt.xin/线程池图片.jpg" alt="Java并发-ThreadPoolExecutor深度解析">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-09T11:33:16.000Z">2020-01-09</time></div>
                    <a href="/2020/01/09/java/Java并发-ThreadPoolExecutor/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Java并发-ThreadPoolExecutor深度解析</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/12/13/distributed/分布式系统分片方法研究/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="分布式系统分片方法研究">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-13T12:33:16.000Z">2019-12-13</time></div>
                    <a href="/2019/12/13/distributed/分布式系统分片方法研究/" class="title has-link-black-ter is-size-6 has-text-weight-normal">分布式系统分片方法研究</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/软件架构/">软件架构</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/12/12/db/Mysql高可用架构总结/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Mysql高可用架构总结">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-12T12:33:16.000Z">2019-12-12</time></div>
                    <a href="/2019/12/12/db/Mysql高可用架构总结/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Mysql高可用架构总结</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Java/">Java</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/07/">
                <span class="level-start">
                    <span class="level-item">七月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/6entinel/">
                        <span class="tag">6entinel</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/APM/">
                        <span class="tag">APM</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/APR/">
                        <span class="tag">APR</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/AQS/">
                        <span class="tag">AQS</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Apollo/">
                        <span class="tag">Apollo</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/BM25/">
                        <span class="tag">BM25</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ElasticAPM/">
                        <span class="tag">ElasticAPM</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ElasticSearch/">
                        <span class="tag">ElasticSearch</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Embedded-Tomcat/">
                        <span class="tag">Embedded Tomcat</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HAProxy/">
                        <span class="tag">HAProxy</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Hbase/">
                        <span class="tag">Hbase</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/IK/">
                        <span class="tag">IK</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java并发-线程池-JUC-ThreadPoolExecutor/">
                        <span class="tag">Java并发 - 线程池 - JUC - ThreadPoolExecutor</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/LTR/">
                        <span class="tag">LTR</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/LVS/">
                        <span class="tag">LVS</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Lambda/">
                        <span class="tag">Lambda</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Lock/">
                        <span class="tag">Lock</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MGR/">
                        <span class="tag">MGR</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mysql/">
                        <span class="tag">Mysql</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Nginx/">
                        <span class="tag">Nginx</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ReentrantLock/">
                        <span class="tag">ReentrantLock</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ReentrantReadWriteLock/">
                        <span class="tag">ReentrantReadWriteLock</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring/">
                        <span class="tag">Spring</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring-Boot/">
                        <span class="tag">Spring Boot</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring-Cloud/">
                        <span class="tag">Spring Cloud</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring-Cloud-Gateway/">
                        <span class="tag">Spring Cloud Gateway</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/SpringCloud/">
                        <span class="tag">SpringCloud</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/TF-IDF/">
                        <span class="tag">TF-IDF</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Tomcat/">
                        <span class="tag">Tomcat</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/java/">
                        <span class="tag">java</span>
                        <span class="tag is-grey">13</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/jenkins/">
                        <span class="tag">jenkins</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/jmeter/">
                        <span class="tag">jmeter</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/lucene/">
                        <span class="tag">lucene</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/range-based/">
                        <span class="tag">range based</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/reactor/">
                        <span class="tag">reactor</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/spring/">
                        <span class="tag">spring</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/spring-boot/">
                        <span class="tag">spring-boot</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/spring-cloud/">
                        <span class="tag">spring-cloud</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/webFlux/">
                        <span class="tag">webFlux</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/一致性Hash/">
                        <span class="tag">一致性Hash</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/主从数据库架构/">
                        <span class="tag">主从数据库架构</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/倒排索引/">
                        <span class="tag">倒排索引</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/函数式编程/">
                        <span class="tag">函数式编程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分词/">
                        <span class="tag">分词</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/反应式编程/">
                        <span class="tag">反应式编程</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/可观察性/">
                        <span class="tag">可观察性</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/向量空间模型/">
                        <span class="tag">向量空间模型</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工厂模式/">
                        <span class="tag">工厂模式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工程架构/">
                        <span class="tag">工程架构</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/布尔模型/">
                        <span class="tag">布尔模型</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发编程/">
                        <span class="tag">并发编程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/建造者模式/">
                        <span class="tag">建造者模式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开发工具/">
                        <span class="tag">开发工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/微服务/">
                        <span class="tag">微服务</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/搜索/">
                        <span class="tag">搜索</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据分片/">
                        <span class="tag">数据分片</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/相关性/">
                        <span class="tag">相关性</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线程/">
                        <span class="tag">线程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/网关/">
                        <span class="tag">网关</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/自动部署/">
                        <span class="tag">自动部署</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/虚拟槽/">
                        <span class="tag">虚拟槽</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/负载均衡/">
                        <span class="tag">负载均衡</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/责任链模式/">
                        <span class="tag">责任链模式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/配置中心/">
                        <span class="tag">配置中心</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/链路追踪/">
                        <span class="tag">链路追踪</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/锁/">
                        <span class="tag">锁</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="Java并发-ThreadPoolExecutor深度解析" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 crowley&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>

<script>
var IcarusThemeSettings = {
    article: {
        highlight: {
            clipboard: true,
            fold: 'true'
        }
    }
};
</script>


    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>




<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>